from typing import List

from regex import Pattern
from enum import Enum
import regex as re



class Tags(Enum):
    PRO_ID = 'pro_id'
    PRO_NAME = 'pro_name'
    PRO_SSH_URL = 'pro_ssh_url'
    PRO_LAST_DATE_EDITED = 'pro_last_date_edited'


class SearchPattern(Enum):
    PRO_ID = re.compile(fr'^.*?\s(?P<{Tags.PRO_ID.value}>\d+?),')
    PRO_NAME = re.compile(fr'^.*?name\W+(?P<{Tags.PRO_NAME.value}>.*?)\',')
    PRO_SSH_URL = re.compile(fr'ssh_url_to_repo\W+(?P<{Tags.PRO_SSH_URL.value}>.*?)\'')
    PRO_LAST_DATE_EDITED = re.compile(fr'last_activity_at\W+(?P<{Tags.PRO_LAST_DATE_EDITED.value}>.*?)T')

    @classmethod
    def proj_patterns(cls) -> List[Pattern]:
        return [value.value for key, value in cls.__members__.items() if 'PRO' in key]

# Example Strings
#  {'id': 365, 'description': 'Linux from Scratch for RaspberryPi 2 /\r\nEmbedded Linux (Prof. Dr. Hubert HÃ¶gl) /\r\nTechnische Informatik 6 /\r\n\r\nMichael Brandl <Michael.Brandl@hs-augsburg.de>,\r\nFerdinand Saufler <Ferdinand.Saufler@hs-augsburg.de>', 'name': 'pi-lfs', 'name_with_namespace': 'Michael Brandl / pi-lfs', 'path': 'pi-lfs', 'path_with_namespace': 'michael.brandl/pi-lfs', 'created_at': '2015-04-17T12:22:08.000Z', 'default_branch': 'master', 'tag_list': ['LFS', 'RPi'], 'topics': ['LFS', 'RPi'], 'ssh_url_to_repo': 'ssh://git@r-n-d.informatik.hs-augsburg.de:2222/michael.brandl/pi-lfs.git', 'http_url_to_repo': 'https://r-n-d.informatik.hs-augsburg.de:8080/michael.brandl/pi-lfs.git', 'web_url': 'https://r-n-d.informatik.hs-augsburg.de:8080/michael.brandl/pi-lfs', 'readme_url': None, 'avatar_url': None, 'forks_count': 0, 'star_count': 0, 'last_activity_at': '2021-04-06T17:05:22.864Z', 'namespace': {'id': 122, 'name': 'Michael Brandl', 'path': 'michael.brandl', 'kind': 'user', 'full_path': 'michael.brandl', 'parent_id': None, 'avatar_url': '/uploads/-/system/user/avatar/111/mbrandl.jpg', 'web_url': 'https://r-n-d.informatik.hs-augsburg.de:8080/michael.brandl'}, '_links': {'self': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/365', 'issues': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/365/issues', 'merge_requests': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/365/merge_requests', 'repo_branches': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/365/repository/branches', 'labels': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/365/labels', 'events': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/365/events', 'members': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/365/members'}, 'packages_enabled': None, 'empty_repo': False, 'archived': False, 'visibility': 'internal', 'owner': {'id': 111, 'name': 'Michael Brandl', 'username': 'michael.brandl', 'state': 'active', 'avatar_url': 'https://r-n-d.informatik.hs-augsburg.de:8080/uploads/-/system/user/avatar/111/mbrandl.jpg', 'web_url': 'https://r-n-d.informatik.hs-augsburg.de:8080/michael.brandl'}, 'resolve_outdated_diff_discussions': None, 'issues_enabled': True, 'merge_requests_enabled': True, 'wiki_enabled': True, 'jobs_enabled': False, 'snippets_enabled': False, 'container_registry_enabled': False, 'service_desk_enabled': False, 'service_desk_address': None, 'can_create_merge_request_in': True, 'issues_access_level': 'enabled', 'repository_access_level': 'enabled', 'merge_requests_access_level': 'enabled', 'forking_access_level': 'enabled', 'wiki_access_level': 'enabled', 'builds_access_level': 'disabled', 'snippets_access_level': 'disabled', 'pages_access_level': 'public', 'operations_access_level': 'enabled', 'analytics_access_level': 'enabled', 'container_registry_access_level': 'disabled', 'emails_disabled': None, 'shared_runners_enabled': True, 'lfs_enabled': True, 'creator_id': 111, 'import_status': 'none', 'open_issues_count': 0, 'ci_default_git_depth': None, 'ci_forward_deployment_enabled': None, 'ci_job_token_scope_enabled': False, 'public_jobs': True, 'build_timeout': 3600, 'auto_cancel_pending_pipelines': 'enabled', 'build_coverage_regex': None, 'ci_config_path': None, 'shared_with_groups': [], 'only_allow_merge_if_pipeline_succeeds': False, 'allow_merge_on_skipped_pipeline': None, 'restrict_user_defined_variables': False, 'request_access_enabled': True, 'only_allow_merge_if_all_discussions_are_resolved': None, 'remove_source_branch_after_merge': None, 'printing_merge_request_link_enabled': True, 'merge_method': 'merge', 'squash_option': 'default_off', 'suggestion_commit_message': None, 'auto_devops_enabled': False, 'auto_devops_deploy_strategy': 'continuous', 'autoclose_referenced_issues': True, 'keep_latest_artifact': True, 'permissions': {'project_access': None, 'group_access': None}}
#  {'id': 332, 'description': '', 'name': 'canvert2015', 'name_with_namespace': 'Andreas Drexel / canvert2015', 'path': 'canvert2015', 'path_with_namespace': 'andreas.drexel/canvert2015', 'created_at': '2015-04-03T09:49:05.000Z', 'default_branch': 'master', 'tag_list': [], 'topics': [], 'ssh_url_to_repo': 'ssh://git@r-n-d.informatik.hs-augsburg.de:2222/andreas.drexel/canvert2015.git', 'http_url_to_repo': 'https://r-n-d.informatik.hs-augsburg.de:8080/andreas.drexel/canvert2015.git', 'web_url': 'https://r-n-d.informatik.hs-augsburg.de:8080/andreas.drexel/canvert2015', 'readme_url': None, 'avatar_url': None, 'forks_count': 0, 'star_count': 0, 'last_activity_at': '2015-07-22T16:17:09.000Z', 'namespace': {'id': 77, 'name': 'Andreas Drexel', 'path': 'andreas.drexel', 'kind': 'user', 'full_path': 'andreas.drexel', 'parent_id': None, 'avatar_url': 'https://seccdn.libravatar.org/avatar/6f37c1ba244e25e821cb3596e66e806e?s=80&d=identicon', 'web_url': 'https://r-n-d.informatik.hs-augsburg.de:8080/andreas.drexel'}, '_links': {'self': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/332', 'issues': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/332/issues', 'merge_requests': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/332/merge_requests', 'repo_branches': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/332/repository/branches', 'labels': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/332/labels', 'events': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/332/events', 'members': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/332/members'}, 'packages_enabled': None, 'empty_repo': False, 'archived': False, 'visibility': 'internal', 'owner': {'id': 69, 'name': 'Andreas Drexel', 'username': 'andreas.drexel', 'state': 'active', 'avatar_url': 'https://seccdn.libravatar.org/avatar/6f37c1ba244e25e821cb3596e66e806e?s=80&d=identicon', 'web_url': 'https://r-n-d.informatik.hs-augsburg.de:8080/andreas.drexel'}, 'resolve_outdated_diff_discussions': None, 'issues_enabled': True, 'merge_requests_enabled': True, 'wiki_enabled': True, 'jobs_enabled': True, 'snippets_enabled': False, 'container_registry_enabled': False, 'service_desk_enabled': False, 'service_desk_address': None, 'can_create_merge_request_in': True, 'issues_access_level': 'enabled', 'repository_access_level': 'enabled', 'merge_requests_access_level': 'enabled', 'forking_access_level': 'enabled', 'wiki_access_level': 'enabled', 'builds_access_level': 'enabled', 'snippets_access_level': 'disabled', 'pages_access_level': 'public', 'operations_access_level': 'enabled', 'analytics_access_level': 'enabled', 'container_registry_access_level': 'disabled', 'emails_disabled': None, 'shared_runners_enabled': True, 'lfs_enabled': True, 'creator_id': 69, 'import_status': 'none', 'open_issues_count': 0, 'ci_default_git_depth': None, 'ci_forward_deployment_enabled': None, 'ci_job_token_scope_enabled': False, 'public_jobs': True, 'build_timeout': 3600, 'auto_cancel_pending_pipelines': 'enabled', 'build_coverage_regex': None, 'ci_config_path': None, 'shared_with_groups': [], 'only_allow_merge_if_pipeline_succeeds': False, 'allow_merge_on_skipped_pipeline': None, 'restrict_user_defined_variables': False, 'request_access_enabled': True, 'only_allow_merge_if_all_discussions_are_resolved': None, 'remove_source_branch_after_merge': None, 'printing_merge_request_link_enabled': True, 'merge_method': 'merge', 'squash_option': 'default_off', 'suggestion_commit_message': None, 'auto_devops_enabled': False, 'auto_devops_deploy_strategy': 'continuous', 'autoclose_referenced_issues': True, 'keep_latest_artifact': True, 'permissions': {'project_access': None, 'group_access': None}}



repo_pattern = re.compile("""
            id                              
            \W+                             # tag and value seperated by none 'norm' characters
                (?P<id>                    
                    \d+?                    # capture id consisting of one or more numbers
                )                           
            \,.*?name\W+
                (?P<name>                   
                    [\w\-\s]+?              # capture name consisting of [a-zA-Z_- and spacing] 
                )\'                         # non-greedy ends with apostrophe
            .*?ssh_url_to_repo\W+
                (?P<url>                    
                    .*?                     # capture url non-greedy 
                )                           
            \'.*?last_activity_at\W+        # group capture ends with apostrophe
                (?P<date>                   
                    \d{4}-\d{2}-\d{2}       # capture date format YYYY-MM-DD
                )                 
            """, flags=re.M | re.S | re.VERBOSE)

server_port_pattern = re.compile("""
            \@                   
                (?P<server>          
                    .*                  # capture anything greedy from @ to : 
                )                    
                    (?=:                # look ahead for :
                (?P<port>            
                    \d+                 # any digit greedy
                )                    
            )                   
            """, flags=re.M | re.S | re.VERBOSE)


# Example String Repository
# ["{'id': 7041, 'description': '', 'name': '7', 'name_with_namespace': 'Martin Springer / 7', 'path': '7', 'path_with_namespace': 'martinsp/7', 'created_at': '2021-10-27T10:06:23.540Z', 'default_branch': 'main', 'tag_list': [], 'topics': [], 'ssh_url_to_repo': 'ssh://git@r-n-d.informatik.hs-augsburg.de:2222/martinsp/7.git', 'http_url_to_repo': 'https://r-n-d.informatik.hs-augsburg.de:8080/martinsp/7.git', 'web_url': 'https://r-n-d.informatik.hs-augsburg.de:8080/martinsp/7', 'readme_url': 'https://r-n-d.informatik.hs-augsburg.de:8080/martinsp/7/-/blob/main/README.md', 'avatar_url': None, 'forks_count': 0, 'star_count': 0, 'last_activity_at': '2021-10-27T10:06:23.540Z', 'namespace': {'id': 3173, 'name': 'Martin Springer', 'path': 'martinsp', 'kind': 'user', 'full_path': 'martinsp', 'parent_id': None, 'avatar_url': 'https://seccdn.libravatar.org/avatar/6ecb5949e8c33e48ac55858fdee6fe81?s=80&d=identicon', 'web_url': 'https://r-n-d.informatik.hs-augsburg.de:8080/martinsp'}, '_links': {'self': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/7041', 'issues': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/7041/issues', 'merge_requests': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/7041/merge_requests', 'repo_branches': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/7041/repository/branches', 'labels': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/7041/labels', 'events': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/7041/events', 'members': 'https://r-n-d.informatik.hs-augsburg.de:8080/api/v4/projects/7041/members'}, 'packages_enabled': True, 'empty_repo': False, 'archived': False, 'visibility': 'internal', 'owner': {'id': 2461, 'name': 'Martin Springer', 'username': 'martinsp', 'state': 'active', 'avatar_url': 'https://seccdn.libravatar.org/avatar/6ecb5949e8c33e48ac55858fdee6fe81?s=80&d=identicon', 'web_url': 'https://r-n-d.informatik.hs-augsburg.de:8080/martinsp'}, 'resolve_outdated_diff_discussions': False, 'container_expiration_policy': {'cadence': '1d', 'enabled': False, 'keep_n': 10, 'older_than': '90d', 'name_regex': '.*', 'name_regex_keep': None, 'next_run_at': '2021-10-28T10:06:23.552Z'}, 'issues_enabled': True, 'merge_requests_enabled': True, 'wiki_enabled': True, 'jobs_enabled': True, 'snippets_enabled': True, 'container_registry_enabled': True, 'service_desk_enabled': False, 'service_desk_address': None, 'can_create_merge_request_in': True, 'issues_access_level': 'enabled', 'repository_access_level': 'enabled', 'merge_requests_access_level': 'enabled', 'forking_access_level': 'enabled', 'wiki_access_level': 'enabled', 'builds_access_level': 'enabled', 'snippets_access_level': 'enabled', 'pages_access_level': 'private', 'operations_access_level': 'enabled', 'analytics_access_level': 'enabled', 'container_registry_access_level': 'enabled', 'emails_disabled': None, 'shared_runners_enabled': True, 'lfs_enabled': True, 'creator_id': 2461, 'forked_from_project': {'id': 6991, 'description': '', 'name': '7', 'name_with_namespace': 'es2 / ws21 / 7', 'path': '7', 'path_with_namespace': 'es2/ws21/7', 'created_at': '2021-10-19T18:53:05.298Z', 'default_branch': 'main', 'tag_list': [], 'topics': [], 'ssh_url_to_repo': 'ssh://git@r-n-d.informatik.hs-augsburg.de:2222/es2/ws21/7.git', 'http_url_to_repo': 'https://r-n-d.informatik.hs-augsburg.de:8080/es2/ws21/7.git', 'web_url': 'https://r-n-d.informatik.hs-augsburg.de:8080/es2/ws21/7', 'readme_url': 'https://r-n-d.informatik.hs-augsburg.de:8080/es2/ws21/7/-/blob/main/README.md', 'avatar_url': None, 'forks_count': 3, 'star_count': 1, 'last_activity_at': '2021-10-27T14:04:07.184Z', 'namespace': {'id': 3708, 'name': 'ws21', 'path': 'ws21', 'kind': 'group', 'full_path': 'es2/ws21', 'parent_id': 1087, 'avatar_url': None, 'web_url': 'https://r-n-d.informatik.hs-augsburg.de:8080/groups/es2/ws21'}}, 'import_status': 'finished', 'open_issues_count': 0, 'ci_default_git_depth': 50, 'ci_forward_deployment_enabled': True, 'ci_job_token_scope_enabled': False, 'public_jobs': True, 'build_timeout': 3600, 'auto_cancel_pending_pipelines': 'enabled', 'build_coverage_regex': None, 'ci_config_path': '', 'shared_with_groups': [], 'only_allow_merge_if_pipeline_succeeds': False, 'allow_merge_on_skipped_pipeline': None, 'restrict_user_defined_variables': False, 'request_access_enabled': True, 'only_allow_merge_if_all_discussions_are_resolved': False, 'remove_source_branch_after_merge': True, 'printing_merge_request_link_enabled': True, 'merge_method': 'merge', 'squash_option': 'default_off', 'suggestion_commit_message': None, 'auto_devops_enabled': False, 'auto_devops_deploy_strategy': 'continuous', 'autoclose_referenced_issues': True,